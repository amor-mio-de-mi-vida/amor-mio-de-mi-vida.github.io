<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="amor mío de mi vida">
    
    <title>
        
            Shared Memory Programming Mostly OpenMP |
        
        Hesen's Blog
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    
        <link rel="shortcut icon" href="/images/avatar.svg">
    
    
<link rel="stylesheet" href="/font/css/fontawesome.min.css">

    
<link rel="stylesheet" href="/font/css/regular.min.css">

    
<link rel="stylesheet" href="/font/css/solid.min.css">

    
<link rel="stylesheet" href="/font/css/brands.min.css">

    
    <script class="keep-theme-configurations">
    const KEEP = window.KEEP || {}
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en","path":"search.xml"}
    KEEP.theme_config = {"title":"Keep","subtitle":"Hexo theme keep quick starter","description":"","keywords":null,"author":"Keep Team","language":"en","timezone":"","url":"http://example.com","permalink":":year/:month/:day/:name/","permalink_defaults":null,"pretty_urls":{"trailing_index":true,"trailing_html":true},"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":{"enable":true,"field":"site","exclude":""},"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"line_number":true,"auto_detect":false,"tab_replace":"","wrap":true,"hljs":false},"prismjs":{"enable":false,"preprocess":true,"line_number":true,"tab_replace":""},"index_generator":{"path":"","per_page":10,"order_by":"-date"},"default_category":"uncategorized","category_map":null,"tag_map":null,"meta_generator":true,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","updated_option":"mtime","per_page":10,"pagination_dir":"page","include":null,"exclude":null,"ignore":null,"theme":"keep","deploy":{"type":""},"search":{"path":"search.json","field":"post","content":true,"format":"striptags"},"feed":{"type":"atom","path":"atom.xml","limit":20},"math":{"perpage":true,"mathjax":{"enable":true,"mhchem":false}},"root":"","base_info":{"primary_color":"#0066cc","title":"Hesen's Blog","author":"amor mío de mi vida","avatar":"/images/avatar.svg","logo":"/images/avatar.svg","favicon":"/images/avatar.svg"},"menu":{"home":"/                       || fa-solid fa-home","archives":"/archives           || fa-solid fa-box-archive","tags":"/tags                   || fa-solid fa-tags","categories":"/categories       || fa-solid fa-layer-group","about":"/about                 || fa-solid fa-user","github":"https://github.com/amor-mio-de-mi-vida || fa-brands fa-github"},"first_screen":{"enable":true,"background_img":"/images/bg.svg","background_img_dark":"/images/bg.svg","description":"Audentis fortuna iuvat.","hitokoto":false},"social_contact":{"enable":true,"links":{"github":"https://github.com/amor-mio-de-mi-vida","weixin":"img |","qq":null,"weibo":null,"zhihu":null,"twitter":null,"x":null,"facebook":null,"email":null}},"scroll":{"progress_bar":false,"percent":true,"hide_header":true},"home":{"announcement":null,"category":true,"tag":true,"post_datetime":"updated"},"post":{"author_badge":{"enable":true,"level_badge":true,"custom_badge":["One","Two","Three"]},"word_count":{"wordcount":true,"min2read":true},"datetime_format":"YYYY-MM-DD HH:mm:ss","copyright_info":true,"share":true,"reward":{"enable":false,"img_link":null,"text":null}},"code_block":{"tools":{"enable":true,"style":"default"},"highlight_theme":"default"},"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true,"layout":"right"},"website_count":{"busuanzi_count":{"enable":true,"site_uv":true,"site_pv":true,"page_pv":true}},"local_search":{"enable":true,"preload":true},"comment":{"enable":false,"use":"valine","valine":{"appid":null,"appkey":null,"server_urls":null,"placeholder":null},"gitalk":{"github_id":null,"github_admins":null,"repository":null,"client_id":null,"client_secret":null,"proxy":null},"twikoo":{"env_id":null,"region":null,"version":"1.6.36"},"waline":{"server_url":null,"reaction":false,"version":"3.2.1"},"giscus":{"repo":null,"repo_id":null,"category":"Announcements","category_id":null,"reactions_enabled":false},"artalk":{"server":null},"disqus":{"shortname":null}},"rss":{"enable":false},"lazyload":{"enable":true},"cdn":{"enable":false,"provider":"cdnjs"},"pjax":{"enable":true},"footer":{"since":2020,"word_count":false,"site_deploy":{"enable":false,"provider":"github","url":null},"record":{"enable":false,"list":[{"code":null,"link":null}]}},"inject":{"enable":false,"css":[null],"js":[null]},"source_data":{},"version":"4.2.3"}
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"}
    KEEP.language_code_block = {"copy":"Copy code","copied":"Copied","fold":"Fold code block","folded":"Folded"}
    KEEP.language_copy_copyright = {"copy":"Copy copyright info","copied":"Copied","title":"Original post title","author":"Original post author","link":"Original post link"}
  </script>
<meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
</head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <i class="pjax-progress-icon fas fa-circle-notch fa-spin"></i>
    
</div>



<main class="page-container border-box">
    <!-- home first screen  -->
    

    <!-- page content -->
    <div class="page-main-content border-box">
        <div class="page-main-content-top">
            
<header class="header-wrapper">

    <div class="border-box header-content">
        <div class="left flex-start border-box">
            
                <a class="logo-image border-box" href="/">
                    <img src="/images/avatar.svg">
                </a>
            
            <a class="site-name border-box" href="/">
               Hesen's Blog
            </a>
        </div>

        <div class="right border-box">
            <div class="pc border-box">
                <ul class="menu-list border-box">
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-home"></i>
                                
                                HOME
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/archives">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                
                                ARCHIVES
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/tags">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-tags"></i>
                                
                                TAGS
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/categories">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                
                                CATEGORIES
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" href="/about">
                                
                                    <i class="menu-text-color menu-icon fa-solid fa-user"></i>
                                
                                ABOUT
                                
                            </a>
                            
                        </li>
                    
                        
                        <li class="menu-item flex-start border-box">
                            <a class="menu-text-color border-box" target="_blank" rel="noopener" href="https://github.com/amor-mio-de-mi-vida">
                                
                                    <i class="menu-text-color menu-icon fa-brands fa-github"></i>
                                
                                GITHUB
                                
                            </a>
                            
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="menu-text-color fas search fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile border-box flex-start">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list border-box">
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-home"></i>
                                </span>
                            
                            HOME
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/archives">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-box-archive"></i>
                                </span>
                            
                            ARCHIVES
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/tags">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-tags"></i>
                                </span>
                            
                            TAGS
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/categories">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-layer-group"></i>
                                </span>
                            
                            CATEGORIES
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" href="/about">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-solid fa-user"></i>
                                </span>
                            
                            ABOUT
                        </a>
                        
                    </label>
                    
                </li>
            
                
                <li class="drawer-menu-item border-box not-sub-menu">
                    <label class="drawer-menu-label border-box">
                        <a class="drawer-menu-text-color left-side flex-start border-box" target="_blank" rel="noopener" href="https://github.com/amor-mio-de-mi-vida">
                            
                                <span class="menu-icon-wrap border-box flex-center">
                                    <i class="drawer-menu-text-color menu-icon fa-brands fa-github"></i>
                                </span>
                            
                            GITHUB
                        </a>
                        
                    </label>
                    
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle border-box">

            <div class="main-content border-box">
                

                    
<div class="fade-in-down-animation">
    <div class="post-page-container border-box">
        <div class="post-content-container border-box">
            

            <div class="post-content-bottom border-box">
                
                    <div class="post-title">
                        Shared Memory Programming Mostly OpenMP
                    </div>
                

                
                    <div class="post-header border-box">
                        
                            <div class="avatar-box border-box">
                                <img src="/images/avatar.svg">
                            </div>
                        
                        <div class="info-box">
                            <div class="author border-box">
                                <span class="name">amor mío de mi vida</span>
                                
                                    <span class="author-badge">Lv4</span>
                                
                            </div>
                            <div class="meta-info border-box">
                                

<div class="post-meta-info-container border-box post">
    <div class="post-meta-info border-box">
        

        
            <span class="meta-info-item post-create-date">
                <i class="icon fa-solid fa-calendar-plus"></i>&nbsp;
                <span class="datetime">2024-11-04 19:20:29</span>
            </span>

            <span class="meta-info-item post-update-date">
                <i class="icon fa-solid fa-file-pen"></i>&nbsp;
                <span class="datetime" data-updated="Fri Nov 08 2024 11:39:24 GMT+0800">2024-11-08 11:39:24</span>
            </span>
        

        
            <span class="meta-info-item post-category border-box"><i class="icon fas fa-folder"></i>&nbsp;
                <ul class="post-category-ul">
                    
                            <li class="category-item"><a href="/categories/cs267/">cs267</a></li>
                        
                    
                </ul>
            </span>
        

        
            <span class="post-tag meta-info-item border-box">
                <ul class="post-tag-ul">
                    
                            <li class="tag-item"><span class="tag-separator"><i class="icon fas fa-hashtag"></i></span><a href="/tags/course/">course</a></li>
                        
                    
                </ul>
            </span>
        

        
        
            <span class="meta-info-item post-wordcount">
                <i class="icon fas fa-file-word"></i>&nbsp;<span>3.8k Words</span>
            </span>
        
        
            <span class="meta-info-item post-min2read">
                <i class="icon fas fa-clock"></i>&nbsp;<span>23 Mins</span>
            </span>
        
        
            <span class="meta-info-item post-pv">
                <i class="icon fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
            </span>
        
    </div>

    
</div>

                            </div>
                        </div>
                    </div>
                

                <div class="post-content keep-markdown-body ">
                    

                    
                         <h2 id="shared-memory">Shared Memory</h2>
<ul>
<li><p>Program is a collection of threads of control (Can be created
dynamically, mid-execution, in some languages).</p></li>
<li><p>Each thread has a set of private variables, e.g., local stack
variables</p></li>
<li><p>Also a set of shared variables, e.g., static variables, shared
common blocks, or global heap.</p></li>
</ul>
<p>Threads communicate <strong>implicitly</strong> by writing and
reading shared variables.</p>
<p>Threads coordinate by <strong>synchronizing</strong> on shared
variables.</p>
<h2 id="parallel-programming-with-threads">Parallel Programming with
Threads</h2>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Signature:</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_create</span><span class="params">(<span class="type">pthread_t</span> *, <span class="type">const</span> <span class="type">pthread_attr_t</span>*,</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="type">void</span>* (*)(<span class="type">void</span>*),</span></span></span><br><span class="line"><span class="params"><span class="function">				    <span class="type">void</span>*)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Example call</span></span><br><span class="line">errcode = <span class="built_in">pthread_create</span>(&amp;thread_id, &amp;thread_attribute, </span><br><span class="line">						&amp;thread_fun, &amp;fun_arg);</span><br></pre></td></tr></tbody></table></figure>
<p><code>thread_id</code> is the thread id or handle (used to halt,
etc.)</p>
<p><code>thread_attribute</code> various attributes</p>
<ul>
<li><p>Standard default values obtained by passing a NULL
pointer.</p></li>
<li><p>Sample attributes: minimum stack size, priority.</p></li>
</ul>
<p><code>thread_fun</code> the function to be run (takes and returns
void*)</p>
<p><code>fun_arg</code> an argument can be passed to thread_fun when it
starts</p>
<p><code>errorcode</code> will be nonzero if the create operation
fails.</p>
<h3 id="recall-data-race-example">Recall Data Race Example</h3>
<p>Problem is a race condition on variable s in the program</p>
<p>A race condition or data race occurs when:</p>
<ul>
<li><p>two processors (or two threads) access the same variable, and at
least one does a write.</p></li>
<li><p>The accesses are concurrent (not synchronized) so they could
happen simultaneously.</p></li>
</ul>
<p>Mutexes —— mutual exclusion aka locks</p>
<ul>
<li><p>threads are working mostly independently</p></li>
<li><p>need to access common data structure</p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">lock* mutex = <span class="built_in">alloc_and_init</span>(); <span class="comment">/* shared */</span></span><br><span class="line"><span class="built_in">acquire</span>(<span class="number">1</span>);</span><br><span class="line">	<span class="function">access data</span></span><br><span class="line"><span class="function"><span class="title">release</span><span class="params">(<span class="number">1</span>)</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Locks only affect processors using them: if a thread accesses the
data without doing the acquire/release, locks by others will not
help</p></li>
<li><p>Java, C++ and other languages have lexically scoped
synchronization, i.e., synchronized methods/blocks</p></li>
<li><p>Semaphores (a signaling mechanism) generalize locks to allow k
threads simultaneous access; good for limited resources.</p></li>
<li><p>Unlike in a mutex, a semaphore can be decremented by another
process (a mutex can only be unlocked by its owner)</p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// To create a mutex:</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="type">pthread_mutex_t</span> amutex = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="comment">// or pthread_mutex_init(&amp;amutex, NULL)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// To use it:</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_lock</span><span class="params">(amutex)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_unlock</span><span class="params">(amutex)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To deallocate a mutex</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pthread_mutex_destroy</span><span class="params">(<span class="type">pthread_mutex_t</span> * mutex)</span></span></span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Multiple mutexes may be held, but can lead to problems.</p></li>
<li><p>Dead lock results if both threads acquire one of their locks, so
that neither can acquire the second.</p></li>
</ul>
<p><strong>Pitfalls</strong></p>
<ul>
<li><p>Overhead of thread creation is high (1-loop iteration probably
too much)</p></li>
<li><p>Data race bugs are very nasty to find because they can be
intermittent</p></li>
</ul>
<p>Researchers look at transactional memory an alternative</p>
<p>OpenMP is commonly used today as an alternative</p>
<ul>
<li>Helps with some of these, but doesn't make them disappear.</li>
</ul>
<p>As application programmers, you're better off avoiding these P-thread
programming due to the pitfalls such as the need to manually assign
work, balance it out, and make sure there's no oversubscription, make
sure the deadlocks do not happen.</p>
<h3 id="a-programmers-view-of-openmp">A Programmer's View of OpenMP</h3>
<p>OpenMP is a portable, threaded, shared-memory programming
<em>specification</em> with "light" syntax.</p>
<ul>
<li>Requires compiler support</li>
</ul>
<p>OpenMP will:</p>
<ul>
<li><p>Allow a programmer to separate a program into <em>serial
regions</em> and <em>parallel regions</em>, rather than P
concurrently-executing threads.</p></li>
<li><p>Hide stack management</p></li>
<li><p>Provide synchronization constructs.</p></li>
</ul>
<p>OpenMP will not:</p>
<ul>
<li><p>Parallelize automatically</p></li>
<li><p>Guarantee speedup</p></li>
<li><p>Provide freedom from data races</p></li>
</ul>
<table>
<colgroup>
<col style="width: 31%">
<col style="width: 68%">
</colgroup>
<thead>
<tr>
<th>OpenMP pragma, function, or clause</th>
<th>Concepts</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>#pragma omp parallel</code></td>
<td>Parallel region, teams of threads, structured block, interleaved
execution across threads</td>
</tr>
<tr>
<td><code>int omp_get_thread_num()</code><br><code>int omp_get_num_threads()</code></td>
<td>Create threads with a parallel region and split up the work using
the number of threads and thread ID</td>
</tr>
<tr>
<td><code>double omp_get_wtime()</code></td>
<td>Speedup and Amdahl's law.<br>False Sharing and other performance
issues</td>
</tr>
<tr>
<td><code>setenv OMP_NUM_THREADS N</code></td>
<td>Internal control variables. Setting the default number of threads
with an environment variable</td>
</tr>
<tr>
<td><code>#pragma omp barrier</code><br><code>#pragma omp critical</code></td>
<td>Synchronization and race conditions. Revisit interleaved
execution.</td>
</tr>
<tr>
<td><code>#pragma omp for</code><br><code>#pragma omp parallel for</code></td>
<td>Worksharing, parallel loops, loop carried dependencies</td>
</tr>
<tr>
<td><code>reduction(op:list)</code></td>
<td>Reductions of values across a team of threads</td>
</tr>
<tr>
<td><code>schedule(dynamic [,chunk])</code><br><code>schedule(static [,chunk])</code></td>
<td>Loop schedules, loop overheads and load balance</td>
</tr>
<tr>
<td><code>private(list)</code><br><code>firstprivate(list)</code><br><code>shared(list)</code></td>
<td>Data environment</td>
</tr>
<tr>
<td><code>nowait</code></td>
<td>Disabling implied barriers on workshare constructs, the high cost of
barriers, and the flush concept (but not the flush directive)</td>
</tr>
<tr>
<td><code>#pragma omp single</code></td>
<td>Workshare with a single thread</td>
</tr>
<tr>
<td><code>#pragma omp task</code><br><code>#pragma omp taskwait</code></td>
<td>Tasks including the data environment for tasks.</td>
</tr>
</tbody>
</table>
<p>Switches for compiling and linking</p>
<p><code>gcc -fopenmp</code> <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.054ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.242ex" role="img" focusable="false" viewBox="0 -525 1000 549"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="21D2" d="M580 514Q580 525 596 525Q601 525 604 525T609 525T613 524T615 523T617 520T619 517T622 512Q659 438 720 381T831 300T927 263Q944 258 944 250T935 239T898 228T840 204Q696 134 622 -12Q618 -21 615 -22T600 -24Q580 -24 580 -17Q580 -13 585 0Q620 69 671 123L681 133H70Q56 140 56 153Q56 168 72 173H725L735 181Q774 211 852 250Q851 251 834 259T789 283T735 319L725 327H72Q56 332 56 347Q56 360 70 367H681L671 377Q638 412 609 458T580 514Z"></path></g></g></g></svg></mjx-container></span> GNU (Linux, OSX)</p>
<p><code>pgcc -mp pgi</code> <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.054ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.242ex" role="img" focusable="false" viewBox="0 -525 1000 549"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="21D2" d="M580 514Q580 525 596 525Q601 525 604 525T609 525T613 524T615 523T617 520T619 517T622 512Q659 438 720 381T831 300T927 263Q944 258 944 250T935 239T898 228T840 204Q696 134 622 -12Q618 -21 615 -22T600 -24Q580 -24 580 -17Q580 -13 585 0Q620 69 671 123L681 133H70Q56 140 56 153Q56 168 72 173H725L735 181Q774 211 852 250Q851 251 834 259T789 283T735 319L725 327H72Q56 332 56 347Q56 360 70 367H681L671 377Q638 412 609 458T580 514Z"></path></g></g></g></svg></mjx-container></span> PGI (Linux)</p>
<p><code>icl/Qopenmp</code> <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.054ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.242ex" role="img" focusable="false" viewBox="0 -525 1000 549"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="21D2" d="M580 514Q580 525 596 525Q601 525 604 525T609 525T613 524T615 523T617 520T619 517T622 512Q659 438 720 381T831 300T927 263Q944 258 944 250T935 239T898 228T840 204Q696 134 622 -12Q618 -21 615 -22T600 -24Q580 -24 580 -17Q580 -13 585 0Q620 69 671 123L681 133H70Q56 140 56 153Q56 168 72 173H725L735 181Q774 211 852 250Q851 251 834 259T789 283T735 319L725 327H72Q56 332 56 347Q56 360 70 367H681L671 377Q638 412 609 458T580 514Z"></path></g></g></g></svg></mjx-container></span> Intel (windows)</p>
<p><code>icc -fopenmp</code> <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.054ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="1.242ex" role="img" focusable="false" viewBox="0 -525 1000 549"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="21D2" d="M580 514Q580 525 596 525Q601 525 604 525T609 525T613 524T615 523T617 520T619 517T622 512Q659 438 720 381T831 300T927 263Q944 258 944 250T935 239T898 228T840 204Q696 134 622 -12Q618 -21 615 -22T600 -24Q580 -24 580 -17Q580 -13 585 0Q620 69 671 123L681 133H70Q56 140 56 153Q56 168 72 173H725L735 181Q774 211 852 250Q851 251 834 259T789 283T735 319L725 327H72Q56 332 56 347Q56 360 70 367H681L671 377Q638 412 609 458T580 514Z"></path></g></g></g></svg></mjx-container></span> Intel (Linux, OSX)</p>
<p>OpenMP is not forced to kill the threads and recreate them. It can
suspend the threads and send them back to a thread pool and reuse them
in the next parallel region generation.</p>
<p>You can request a number of threads with
<code>omp_set_num_threads()</code></p>
<p>But is the number of threads requested the number you actually
get?</p>
<ul>
<li><p>NO! An implementation can silently decide to give you a team with
fewer threads</p></li>
<li><p>Once a team of threads is established ... the system will not
reduce the size of the team. this is only essentially a suggestion to
the OpenMP runtime.</p></li>
</ul>
<h2 id="shared-memory-hardware-and-memory-consistency">Shared Memory
Hardware and Memory Consistency</h2>
<p>Want high performance for shared memory: Use Caches!</p>
<ul>
<li><p>Each processor has its own cache (or multiple caches)</p></li>
<li><p>Place data from memory into cache</p></li>
<li><p>Writeback cache: don't send all writes over bus to
memory</p></li>
</ul>
<p>Caches reduce average latency</p>
<ul>
<li><p>Automatic replication closer to processor</p></li>
<li><p><em>More</em> important to multiprocessor than uniprocessor:
latencies longer</p></li>
</ul>
<p>Normal uniprocessor mechanisms to access data</p>
<ul>
<li>Loads and Stores form very low-overhead communication primitive</li>
</ul>
<p><strong>Problem: Cache Coherence!</strong></p>
<h3 id="cache-coherence-problem">Cache Coherence Problem</h3>
<figure>
<img lazyload="" alt="image" data-src="https://github.com/amor-mio-de-mi-vida/picx-images-hosting/raw/master/CS-267/image.ic4ro6tcr.webp">
<figcaption aria-hidden="true">image</figcaption>
</figure>
<p>Things to note:</p>
<ul>
<li><p>Processors could see different values for u after event
3</p></li>
<li><p>With write back caches, value written back to memory depends on
happenstance of which cache flushes or writes back value when</p></li>
</ul>
<p>How to fix with a bus: Coherence Protocol</p>
<ul>
<li><p>Use bus to broadcast writes or invalidations</p></li>
<li><p>Simple protocols rely on presence of broadcast medium</p></li>
</ul>
<p>Bus not scalable beyond about 100 processors</p>
<ul>
<li>Capacity, bandwidth limitations.</li>
</ul>
<figure>
<img lazyload="" alt="image" data-src="https://github.com/amor-mio-de-mi-vida/picx-images-hosting/raw/master/CS-267/image.26lhov4w8w.webp">
<figcaption aria-hidden="true">image</figcaption>
</figure>
<h3 id="parallel-pi-program">Parallel PI Program</h3>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> num_steps = <span class="number">100000</span>; <span class="type">double</span> step;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_THREADS 4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> i, nthreads; </span><br><span class="line">	<span class="type">double</span> pi, sum[NUM_THREADS];</span><br><span class="line">	step = <span class="number">1.0</span>/(<span class="type">double</span>)num_steps;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(NUM_THREADS);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">int</span> i, id, nthrds;</span><br><span class="line">		<span class="type">double</span> x;</span><br><span class="line">		id = <span class="built_in">omp_get_thread_num</span>();</span><br><span class="line">		nthrds = <span class="built_in">omp_get_num_threads</span>();</span><br><span class="line">		<span class="keyword">if</span> (id == <span class="number">0</span>) nthreads = nthrds;</span><br><span class="line">		<span class="keyword">for</span> (i = id, sum[id] = <span class="number">0.0</span>; i &lt; num_steps; i = i + nthrds) {</span><br><span class="line">			x = (i + <span class="number">0.5</span>) * step;</span><br><span class="line">			sum[id] += <span class="number">4.0</span>/(<span class="number">1.0</span> + x * x);</span><br><span class="line">		}</span><br><span class="line">	}	</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>, pi=<span class="number">0.0</span>; i &lt; nthreads; i++)</span><br><span class="line">		pi += sum[i] * step;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>For each threads, we're getting like the every nthreads variable.</p>
<h3 id="why-such-poor-scaling-false-sharing">Why such poor scaling?
False sharing</h3>
<p>if independent data elements happen to sit on the same cache line,
each update will cause the cache lines to "slosh back and forth" between
threads ... This is called "false sharing"</p>
<figure>
<img lazyload="" alt="image" data-src="https://github.com/amor-mio-de-mi-vida/picx-images-hosting/raw/master/CS-267/image.8hghnhff5f.webp">
<figcaption aria-hidden="true">image</figcaption>
</figure>
<ul>
<li><p>If you promote scalars to an array to support creation of an SPMD
program, the array elements are contiguous in memory and hence share
cache lines ... Results in poor scalability</p></li>
<li><p>Solution: Pad arrays so elements you use are on distinct cache
lines.</p></li>
</ul>
<p>Eliminate false sharing by padding the sum array</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> num_steps = <span class="number">100000</span>; </span><br><span class="line"><span class="type">double</span> step;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PAD 8 <span class="comment">// assume 64 byte L1 cache line size</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_THREADS 4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> i, nthreads; </span><br><span class="line">	<span class="type">double</span> pi, sum[NUM_THREADS][PAD];</span><br><span class="line">	<span class="comment">// Pad the array so each sum value is in a different cache line</span></span><br><span class="line">	step = <span class="number">1.0</span>/(<span class="type">double</span>)num_steps;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(NUM_THREADS);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">int</span> i, id, nthrds;</span><br><span class="line">		<span class="type">double</span> x;</span><br><span class="line">		id = <span class="built_in">omp_get_thread_num</span>();</span><br><span class="line">		nthrds = <span class="built_in">omp_get_num_threads</span>();</span><br><span class="line">		<span class="keyword">if</span> (id == <span class="number">0</span>) nthreads = nthrds;</span><br><span class="line">		<span class="keyword">for</span> (i = id, sum[id] = <span class="number">0.0</span>; i &lt; num_steps; i = i + nthrds) {</span><br><span class="line">			x = (i + <span class="number">0.5</span>) * step;</span><br><span class="line">			sum[id][<span class="number">0</span>] += <span class="number">4.0</span>/(<span class="number">1.0</span> + x * x);</span><br><span class="line">		}</span><br><span class="line">	}	</span><br><span class="line">	<span class="keyword">for</span> (i=<span class="number">0</span>, pi=<span class="number">0.0</span>; i &lt; nthreads; i++)</span><br><span class="line">		pi += sum[i][<span class="number">0</span>] * step;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="synchronization">Synchronization</h3>
<p>Synchronization is used to impose order constraints and to protect
access to shared data.</p>
<p><strong>Synchronization: critical</strong></p>
<p>Mutual exclusion: Only one thread at a time can enter a critical
region.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> res;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">float</span> B; </span><br><span class="line">	<span class="type">int</span> i, id, nthrds;</span><br><span class="line">	id = <span class="built_in">omp_get_thread_num</span>();</span><br><span class="line">	nthrds = <span class="built_in">omp_get_num_threads</span>();</span><br><span class="line">	<span class="keyword">for</span> (i=id; i&lt;niters; i+=nthrds) {</span><br><span class="line">		B=<span class="built_in">big_jon</span>(i);</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp critical</span></span><br><span class="line">		<span class="comment">// Threads wait their turn -- only one at a time calls consume() </span></span><br><span class="line">		res+=<span class="built_in">consume</span>(B);</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>Synchronization: barrier</strong></p>
<p>Barrier: a point in a program all threads much reach before any
threads are allowed to proceed.</p>
<p>It is a "stand alone" pragma meaning it is not associated with user
code ... it is an executable statement.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> Arr[<span class="number">8</span>], Brr[<span class="number">8</span>]; </span><br><span class="line"><span class="type">int</span> numthrds;</span><br><span class="line"><span class="built_in">omp_set_num_threads</span>(<span class="number">8</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> id, nthrds;</span><br><span class="line">	nthrds = <span class="built_in">omp_get_num_threads</span>();</span><br><span class="line">	<span class="keyword">if</span> (id == <span class="number">0</span>) numthrds = nthrds;</span><br><span class="line">	Arr[id] = <span class="built_in">big_ugly_calc</span>(id, nthrds);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp barrier</span></span><br><span class="line">	<span class="comment">// Threads wait until all threads hit the barrier. Then they can go on.</span></span><br><span class="line">	Brr[id] = <span class="built_in">really_big_and_ugly</span>(id, nthrds, Arr);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Using a critical section to remove impact of false sharing</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> num_steps = <span class="number">100000</span>; </span><br><span class="line"><span class="type">double</span> step;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> NUM_THREADS 4</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> nthreads;</span><br><span class="line">	<span class="type">double</span> pi=<span class="number">0.0</span>;</span><br><span class="line">	step = <span class="number">1.0</span>/(<span class="type">double</span>)num_steps;</span><br><span class="line">	<span class="built_in">omp_set_num_threads</span>(NUM_THREADS);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">int</span> i, id, nthrds;</span><br><span class="line">		<span class="type">double</span> x, sum;</span><br><span class="line">		<span class="comment">// Create a scalar local to each thread to accumulate partial sums</span></span><br><span class="line">		id = <span class="built_in">omp_get_thread_num</span>();</span><br><span class="line">		nthrds = <span class="built_in">omp_get_num_threads</span>();</span><br><span class="line">		<span class="keyword">if</span> (id == <span class="number">0</span>) nthreads = nthrds;</span><br><span class="line">		<span class="keyword">for</span> (i = id, sum = <span class="number">0.0</span>; i &lt; num_steps; i = i + nthrds) {</span><br><span class="line">			x = (i + <span class="number">0.5</span>) * step;</span><br><span class="line">			sum += <span class="number">4.0</span>/(<span class="number">1.0</span>+x*x);</span><br><span class="line">			<span class="comment">// No array, so no false sharing</span></span><br><span class="line">		}</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp critical</span></span><br><span class="line">		pi += sum * step;</span><br><span class="line">		<span class="comment">// Sum goes "out of scope" beyond the parallel region ... so you must sum it in here. Must protect summation into pi in a critical region so updates don't conflict.</span></span><br><span class="line">	}	</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>How can we not do that and let the compiler do the work sharing?</p>
<ul>
<li>The loop work sharing construct splits up loop iterations among the
threads in a team</li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp for</span></span><br><span class="line">	<span class="keyword">for</span> (I=<span class="number">0</span>;I&lt;N;I++) {</span><br><span class="line">	<span class="comment">// The loop control index I is made "private" to each thread by default</span></span><br><span class="line">		<span class="built_in">NEAT_STUFF</span>(I);</span><br><span class="line">	}</span><br><span class="line">	<span class="comment">// Threads wait here until all threads are finished with the parallel loop before any proceed past the end of the loop</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>In general, can we safely assume that two independent declared
variables in the global heap will not reside in the same cache line? ——
It's hard to say. Compiler wouldn't give a whole cache line of space
between consecutive variables on the heap declared independently from
each other.</p>
<h3 id="loop-worksharing-constructs-the-schedule-clause">Loop
worksharing constructs: The schedule clause</h3>
<p>The schedule clause affects how loop iterations are mapped onto
threads</p>
<p><code>schedule (static [, chunk])</code> Deal-out blocks of iteration
of size "chunk" to each thread.</p>
<p><code>schedule (dynamic [, chunk])</code> Each thread grabs "chunk"
iterations off a queue until all iterations have been handled.</p>
<table>
<colgroup>
<col style="width: 11%">
<col style="width: 88%">
</colgroup>
<thead>
<tr>
<th>Schedule Clause</th>
<th>When To use</th>
</tr>
</thead>
<tbody>
<tr>
<td>STATIC</td>
<td>Pre-determined and predictable by the programmer<br>Least work at
runtime: scheduling done at compile-time</td>
</tr>
<tr>
<td>DYNAMIC</td>
<td>Unpredictable, highly variable work per iteration<br>Most work at
runtime: complex scheduling logic used at run-time</td>
</tr>
</tbody>
</table>
<p>You need to somehow decompose actual problem into smaller pieces if
you have variable work in each iteration so that the dynamic can help
you in runtime.</p>
<p>If you have few highly variable workloads, chunks, then there's not
much any scheduling can do for you.</p>
<h3 id="static-vs-dynamic-example">Static vs dynamic example</h3>
<ul>
<li><p>Suppose you are doing <strong>block matrix
multiplication</strong>, i.e. you split each matrix into <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.705ex" height="1.887ex" role="img" focusable="false" viewBox="0 -833.9 1195.6 833.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mn" transform="translate(792,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container></span> submatrices, each of size <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.857ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2147 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(888,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mi" transform="translate(1388,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> by <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.857ex" height="2.262ex" role="img" focusable="false" viewBox="0 -750 2147 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(888,0)"><g data-mml-node="mo"><path data-c="2F" d="M423 750Q432 750 438 744T444 730Q444 725 271 248T92 -240Q85 -250 75 -250Q68 -250 62 -245T56 -231Q56 -221 230 257T407 740Q411 750 423 750Z"></path></g></g><g data-mml-node="mi" transform="translate(1388,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g></g></g></svg></mjx-container></span> and will do <span class="math inline"><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.705ex" height="1.885ex" role="img" focusable="false" viewBox="0 -833.2 1195.6 833.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"></path></g><g data-mml-node="mn" transform="translate(792,363) scale(0.707)"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"></path></g></g></g></g></svg></mjx-container></span> submatrix multiplications (B is
relatively small, say ~10)</p></li>
<li><p>However, matrices are sparse and submatrices have varying number
of nonzeros.</p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; B; i++) {</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; B; j++) {</span><br><span class="line"><span class="comment">// collapsing the first two loops</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; B; k++) {</span><br><span class="line">			<span class="built_in">SpGEMM</span>(<span class="built_in">A</span>(i,k), <span class="built_in">B</span>(k,j), <span class="built_in">C</span>(i,j));</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>these are sparse matrix multiplications and they have variable
workload. The default scheduling is static and it's likely dividing this
up in a load imbalance way. We can use the schedule dynamic.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel schedule(dynamic) for collapse(2)</span></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; B; i++) {</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; B; j++) {</span><br><span class="line"><span class="comment">// collapsing the first two loops</span></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> k = <span class="number">0</span>; k &lt; B; k++) {</span><br><span class="line">			<span class="built_in">SpGEMM</span>(<span class="built_in">A</span>(i,k), <span class="built_in">B</span>(k,j), <span class="built_in">C</span>(i,j));</span><br><span class="line">		}</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>If you have difficulty parallelizing certain loops, because there's a
loop dependency. <strong>The basic approach to fix this thing is to
change that variable to eliminate the loop dependency</strong></p>
<p>Basic approach</p>
<ul>
<li><p>Find compute intensive loops</p></li>
<li><p>Make the loop iterations independent ... So they can safely
execute in any order without loop-carried dependencies</p></li>
<li><p>Place the appropriate OpenMP directive and test.</p></li>
</ul>
<h3 id="reduction">Reduction</h3>
<p>OpenMP reduction clause <code>reduction(op : list)</code></p>
<p>Inside a parallel or a work-sharing construct:</p>
<ul>
<li><p>A local copy of each list variable is made and initialized
depending on the "op" (e.g. 0 for "+")</p></li>
<li><p>Updates occur on the local copy.</p></li>
<li><p>Local copies are reduced into a single value and combined with
the original global value.</p></li>
</ul>
<p>The variables in "list" must be shared in the enclosing parallel
region.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> ave=<span class="number">0.0</span>, A[MAX]; <span class="type">int</span> i;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for reduction (+:ave)</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; MAX;i++) {</span><br><span class="line">	ave += A[i];</span><br><span class="line">}</span><br><span class="line">ave = ave/MAX;</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="type">static</span> long_num_steps = <span class="number">100000</span>;</span><br><span class="line"><span class="type">double</span> step;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="type">double</span> x, pi, sum = <span class="number">0.0</span>;</span><br><span class="line">	step = <span class="number">1.0</span>/(<span class="type">double</span>)num_steps;</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	<span class="comment">// create a team of threads ... without a parallel construct, you'll never have more than one thread</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">double</span> x;</span><br><span class="line">		<span class="comment">// create a scalar local to each thread to hold value of x at the center of each interval</span></span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp for reduction(+:sum)</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; num_steps; i++) {</span><br><span class="line">		<span class="comment">// break up loop iterations and assign them to threads ... setting up a reduction into sum. Note ... the loop index is local to a thread by default.</span></span><br><span class="line">			x = (i<span class="number">+0.5</span>)*step;</span><br><span class="line">			sum = sum + <span class="number">4.0</span>/(<span class="number">1.0</span> + x*x);</span><br><span class="line">		}</span><br><span class="line">		pi = step * sum;</span><br><span class="line">	}</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="the-nowait-clause">The nowait clause</h3>
<p>Barriers are really expensive. You need to understand when they are
implied and how to skip them when its safe to do so.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> A[big], B[big], C[big];</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">int</span> id = <span class="built_in">omp_get_thread_num</span>();</span><br><span class="line">	A[id] = <span class="built_in">big_calc1</span>(id);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp barrier</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp for</span></span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">0</span>; i &lt; N; i++) {</span><br><span class="line">			C[i]=<span class="built_in">big_calc3</span>(i, A);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">//implicit barrier at the end of a for worksharing construct.</span></span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp for nowait</span></span><br><span class="line">		<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) {</span><br><span class="line">			B[i] = <span class="built_in">big_calc2</span>(C, i);</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">// no implicit barrier due to nowait</span></span><br><span class="line">		A[id] = <span class="built_in">big_calc4</span>(id);</span><br><span class="line">}</span><br><span class="line"><span class="comment">// implicit barrier at the end of a parallel region</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="data-environment-default-storage-attributes">Data environment:
Default storage attributes</h3>
<p>Shared memory programming model:</p>
<ul>
<li>Most variables are shared by default</li>
</ul>
<p>Global variables are SHARED among threads</p>
<ul>
<li><p>Fortran: COMMON blocks, SAVE variables, MODULE variables</p></li>
<li><p>C: File scope variables, static</p></li>
<li><p>Both: dynamically allocated memory (ALLOCATE, malloc,
new)</p></li>
</ul>
<p>But not everything is shared ...</p>
<ul>
<li><p>Stack variables in subprograms (Fortran) or functions (C) called
from parallel regions are PRIVATE</p></li>
<li><p>Automatic variables within a statement block are
PRIVATE.</p></li>
</ul>
<h3 id="data-sharing-changing-storage-attributes">Data sharing: Changing
storage attributes</h3>
<p>One can selectively change storage attributes for constructs using
the following clauses</p>
<ul>
<li><p><code>shared(list)</code></p></li>
<li><p><code>private(list)</code></p></li>
<li><p><code>firstprivate(list)</code></p></li>
</ul>
<p>These clauses apply to the OpenMP construct NOT to the entire
region.</p>
<p>These can be used on parallel and for constructs ... other than
shared which can only be used on a parallel construct</p>
<p><strong>Force</strong> the programmer to explicitly define storage
attributes</p>
<h4 id="private-clause">Private clause</h4>
<p><code>private(var)</code> creates a new local copy of var for each
thread</p>
<ul>
<li><p>The value of the private copies is
<strong>uninitialized</strong></p></li>
<li><p>The value of the original variable is unchanged after the
region</p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">wrong</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> tmp = <span class="number">0</span>;</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for private(tmp)</span></span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) </span><br><span class="line">		tmp += j; <span class="comment">// &lt;- tmp was not initialized</span></span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">"%d\n"</span>,tmp); <span class="comment">// &lt;- tmp is 0 here</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>When you need to reference the variable tmp that exists prior to the
construct, we call it the <strong>original variable</strong>.</p>
<h4 id="first-private-clause">First private clause</h4>
<p>Variables initialized from a shared variable</p>
<p>C++ objects are copy-constructed</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">incr = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel for firstprivate(incr)</span></span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= MAX; i++) {</span><br><span class="line">	<span class="keyword">if</span> ((i%<span class="number">2</span>)==<span class="number">0</span>) incr++;</span><br><span class="line">	A[i] = incr; <span class="comment">// &lt;- Each thread gets its own copy of incr with an initial value of 0</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="data-sharing-default-clause">Data sharing: Default clause</h3>
<p><code>default(none)</code>: Forces you to define the storage
attributes for variables that appear inside the static extent of the
construct ... if you fail the complier will complain. Good programming
practice!</p>
<p>You can put the default clause on parallel and parallel + workshare
constructs.</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> i, j=<span class="number">5</span>;</span><br><span class="line">	<span class="type">double</span> x = <span class="number">1.0</span>, y=<span class="number">42.0</span>;</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel for default(none) reduction(*:x)</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) {</span><br><span class="line">		<span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; <span class="number">3</span>; j++) {</span><br><span class="line">			x += <span class="built_in">foobar</span>(i, j, y);</span><br><span class="line">		}</span><br><span class="line">	} <span class="comment">// &lt;- The static extent is the code in the compliation unit that contains the construct.</span></span><br><span class="line">	 <span class="built_in">printf</span>(<span class="string">"x is %f\n"</span>, (<span class="type">float</span>)x);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>The compiler would complain about j and y, which is important since
you don'w want j to be shared.</p>
<p>The full OpenMP specification has other versions of the default
clause, but they are not used very often so we skip them in the common
core.</p>
<h3 id="what-are-tasks">What are tasks?</h3>
<p>Tasks are indenpendent units of work</p>
<p>Tasks are composed of:</p>
<ul>
<li><p>code to execute</p></li>
<li><p>data to compute with</p></li>
</ul>
<p>Threads are assigned to perform the work of each task</p>
<ul>
<li><p>The thread that encounters the task construct may execute the
task immediately</p></li>
<li><p>The threads may defer execution until later</p></li>
</ul>
<p>The task construct includes a structured block of code</p>
<p>Inside a parallel region, a thread encountering a task construct will
package up the code block and its data for execution</p>
<p>Tasks can be nested: i.e. a task may itself generate tasks.</p>
<p>A common Pattern is to have one thread create the tasks while the
other threads wait at a barrier and execute the tasks.</p>
<h3 id="single-worksharing-construct">Single worksharing Construct</h3>
<ul>
<li><p>The single construct denotes a block of code that is executed by
only one thread (not necessarily the master thread).</p></li>
<li><p>A barrier is implied at the end of the single block (can remove
the barrier with a <em>nowait</em> clause)</p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel </span></span><br><span class="line">{</span><br><span class="line">	<span class="built_in">do_many_things</span>();</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp single</span></span><br><span class="line">	{ <span class="built_in">exchange_boundaries</span>(); }</span><br><span class="line">	<span class="built_in">do_many_other_things</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>Task Directive</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel </span></span><br><span class="line">{</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp single</span></span><br><span class="line">	{</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">		<span class="built_in">fred</span>();</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">		<span class="built_in">daisy</span>();</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">		<span class="built_in">billy</span>();</span><br><span class="line">	} <span class="comment">// &lt;- All tasks complelte before this barrier is released</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>You can't start creating tasks within a parallel region. You have to
first make sure that the control goes back to a single thread that will
fire up all the tasks and will get distributed.</p>
<p>The OMP parallel task is one of the few constructs in OpenMP that
doesn't have an implicit weight after it.</p>
<h3 id="whenwhere-are-tasks-complete">When/where are tasks
complete?</h3>
<p>At thread barriers (explicit or implicit)</p>
<ul>
<li>applies to all tasks generated in the current parallel region up to
the barrier</li>
</ul>
<p>At taskwait directive</p>
<ul>
<li><p>i.e. wait until all tasks defined within the scope of the current
task have completed.</p></li>
<li><p>Note: applies only to tasks generated in the current task, not to
"descendants".</p></li>
<li><p>To also wait for descendants, there is the taskgroup
<em>region</em></p></li>
</ul>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp single</span></span><br><span class="line">	{</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">			<span class="built_in">fred</span>();</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">			<span class="built_in">daisy</span>();</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> taskwait</span></span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp task </span></span><br><span class="line">			<span class="built_in">billy</span>(); </span><br><span class="line">	}</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// fred() and daisy() must complete before billy() starts</span></span><br></pre></td></tr></tbody></table></figure>
<p>The behavior you want for tasks is usually firstprivate, because the
task may not be executed until later (and variables may have gone out of
scope)</p>
<ul>
<li>Variables that are private when the task construct is encountered
are firstprivate by default</li>
</ul>
<p>Variables that are shared in all constructs starting from the
innermost enclosing parallel construct are shared by default</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel shared(A) private(B)</span></span><br><span class="line">{</span><br><span class="line">	...</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp task</span></span><br><span class="line">	{</span><br><span class="line">		<span class="type">int</span> C;</span><br><span class="line">		<span class="built_in">compute</span>(A, B, C); </span><br><span class="line">		<span class="comment">// A is shared B is firstprivate C is private</span></span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="fibonacci-numbers">Fibonacci numbers</h3>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">fib</span><span class="params">(<span class="type">int</span> n)</span> </span>{</span><br><span class="line">	<span class="type">int</span> x, y;</span><br><span class="line">	<span class="keyword">if</span> (n &lt; <span class="number">2</span>) <span class="keyword">return</span> n;</span><br><span class="line">	</span><br><span class="line">	x = <span class="built_in">fib</span>(n<span class="number">-1</span>);</span><br><span class="line">	y = <span class="built_in">fib</span>(n<span class="number">-2</span>);</span><br><span class="line">	<span class="keyword">return</span> (x+y);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> NW = <span class="number">5000</span>;</span><br><span class="line">	<span class="built_in">fib</span>(NW);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">fib</span><span class="params">(<span class="type">int</span> n)</span> </span>{</span><br><span class="line">	<span class="type">int</span> x, y;</span><br><span class="line">	<span class="keyword">if</span> (n &lt; <span class="number">2</span>) <span class="keyword">return</span> n;</span><br><span class="line">	</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp task shared(x)</span></span><br><span class="line">	x = <span class="built_in">fib</span>(n<span class="number">-1</span>);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp task shared(y)</span></span><br><span class="line">	y = <span class="built_in">fib</span>(n<span class="number">-2</span>);</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp taskwait</span></span><br><span class="line">	<span class="keyword">return</span> x+y;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">	<span class="type">int</span> NW = <span class="number">5000</span>;</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">	{</span><br><span class="line">		<span class="meta">#<span class="keyword">pragma</span> omp single</span></span><br><span class="line">		<span class="built_in">fib</span>(NW);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<ul>
<li><p>Binary tree of tasks</p></li>
<li><p>Traversed using a recursive function</p></li>
<li><p>A task cannot complete until all tasks below it in the tree are
complete (enforced with taskwait)</p></li>
<li><p>By default, only 2 threads will be activate in most
implementations. Set <code>OMP_MAX_ACTIVE_LEVELS</code> with n &gt; 1 to
get n-levels of <strong>nested parallelism</strong></p></li>
<li><p>x, y are local, and so by default they are private to current
task. <strong>must be shared on child tasks</strong> so they don't
create their own firstprivate copies at this level!</p></li>
</ul>
<h3 id="synchronization-atomic">Synchronization: atomic</h3>
<p>Atomic provides mutual exclusion but only applies to the update of a
memory location (the update of X in the following example)</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp parallel</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">double</span> B;</span><br><span class="line">	B = <span class="built_in">DOIT</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="meta">#<span class="keyword">pragma</span> omp atomic</span></span><br><span class="line">	X += <span class="built_in">big_ugly</span>(B);</span><br><span class="line">	<span class="comment">// Atomic only protects the read/update of X</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="flush-operation">Flush operation</h3>
<p>Defines a sequence point at which a thread enforces a consistent view
of memory</p>
<p>For variables visible to other threads and associated with the flush
operation (the <strong>flush-set</strong>)</p>
<ul>
<li><p>The compiler can't move loads/stores of the flush-set around a
flush:</p>
<ul>
<li>All previous read/writes of the flush-set by this thread have
completed</li>
<li>No subsequent read/writes of the flush-set by this thread have
occurred</li>
</ul></li>
<li><p>Variables in the flush set are moved from temporary storage to
shared memory.</p></li>
<li><p>Reads of variables in the flush set following the flush are
loaded from shared memory.</p></li>
</ul>
<p><mark>The flush makes the calling threads temporary view match the
view in shared memory. Flush by itself does not force
synchronization</mark></p>
<p>Flush forces data to be updated in memory so other threads see the
most recent value</p>
<figure class="highlight c++"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">double</span> A;</span><br><span class="line">A = <span class="built_in">compute</span>();</span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> omp flush(A)</span></span><br><span class="line"><span class="comment">// flush to memory to make sure other threads can pick up the right value</span></span><br></pre></td></tr></tbody></table></figure>
<p>Flush without a list: flush set is all thread visible variables</p>
<p>Flush with a list: flush set is the list of variables</p>
<blockquote>
<p>OpenMP's flush is analogous to a fence in other shared memory
APIs</p>
</blockquote>
<p>A flush operation is implied by OpenMP synchronizations,</p>
<ul>
<li><p>at entry/exit of parallel regions</p></li>
<li><p>at implicit and explicit barriers</p></li>
<li><p>at entry/exit of critical regions</p></li>
<li><p>whenever a lock is set or unset</p></li>
</ul>
<p>(but do not at entry to worksharing regions or entry/exist of master
regions)</p>
<h2 id="take-away">Take Away</h2>
<p><strong>Programming shared memory machines</strong></p>
<ul>
<li><p>May allocate data in large shared region without too many worries
about where</p></li>
<li><p>Memory hierarchy is critical to performance. Even more so than on
uniprocessors, due to coherence traffic</p></li>
<li><p>For performance tuning, watch sharing (both true and
false)</p></li>
</ul>
<p><strong>Semantics</strong></p>
<ul>
<li><p>Need to lock access to shared variable for
read-modify-write.</p></li>
<li><p>Sequential consistency is the natural semantics. Write race-free
programs to get this.</p></li>
<li><p>Architects worked hard to make this work. Caches are coherent
with buses or directories; No caching of remote data on shared address
space machines.</p></li>
<li><p>But compiler and processor may still get in the way. Non-blocking
writes, read prefetching, code motion ...; Avoid races or use
machine-specific fences carefully.</p></li>
</ul>

                    
                </div>

                
                        
<div class="post-copyright-info-container border-box">
    <div class="copyright-info-content border-box">
        <div class="copyright-info-top border-box">
            <div class="copyright-post-title border-box text-ellipsis">
                Shared Memory Programming Mostly OpenMP
            </div>

            <div class="copyright-post-link border-box text-ellipsis">
                2024/11/04/course-CS267-4-Shared-Memory-Programming-Mostly-OpenMP/
            </div>
        </div>

        <div class="copyright-info-bottom border-box">
            <div class="copyright-post-author bottom-item">
                <div class="type">
                    Author
                </div>
                <div class="content">amor mío de mi vida</div>
            </div>

            <div class="post-time bottom-item">
                <div class="type">
                    Published
                </div>
                <div class="content">2024-11-04 19:20</div>
            </div>


            <div class="post-license bottom-item">
                <div class="type">
                    License
                </div>
                <div class="content tooltip" data-tooltip-content="CC BY-NC-SA 4.0">
                    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed" target="_blank">
                        
                            <i class="fa-brands fa-creative-commons"></i>
                            <i class="fa-brands fa-creative-commons-by"></i>
                            <i class="fa-brands fa-creative-commons-nc"></i>
                            <i class="fa-brands fa-creative-commons-sa"></i>
                        
                    </a>
                </div>
            </div>
        </div>

        <i class="copyright-bg fa-solid fa-copyright"></i>
    </div>
    <div class="copy-copyright-info flex-center tooltip" data-tooltip-content="Copy copyright info" data-tooltip-offset-y="-2px">
        <i class="fa-solid fa-copy"></i>
    </div>
</div>

                

                <div class="post-bottom-tags-and-share border-box">
                    <div>
                        
                            <ul class="post-tags-box border-box">
                                
                                    <li class="tag-item border-box">
                                        <i class="icon fas fa-hashtag"></i>&nbsp;<a href="/tags/course/">course</a>
                                    </li>
                                
                            </ul>
                        
                    </div>
                    <div>
                        
                            <div class="post-share-container border-box">
    <ul class="share-list-wrap border-box">
        <li class="qq share-item border-box flex-center tooltip" data-tooltip-content="Share to QQ">
            <i class="fa-brands fa-qq"></i>
        </li>
        <li class="wechat share-item border-box flex-center tooltip tooltip-img" data-tooltip-content="Share to WeChat" data-tooltip-img-tip="Scan by WeChat" data-tooltip-img-style="background-color: #fff; top: -10px; padding: 0.6rem 0.6rem 0.1rem 0.6rem;">
            <i class="fa-brands fa-weixin"></i>
        </li>
        <li class="weibo share-item border-box flex-center tooltip" data-tooltip-content="Share to WeiBo">
            <i class="fa-brands fa-weibo"></i>
        </li>
    </ul>
</div>

                        
                    </div>
                </div>

                

                
                    <div class="post-nav border-box">
                        
                            <div class="prev-post">
                                <a class="prev" rel="prev" href="/2024/11/06/course-Machine-Learning-Compiler-2-Build-End-to-End-Model/" title="Welcome to use Hexo Theme Keep">
                                    <span class="left arrow-icon flex-center">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Welcome to use Hexo Theme Keep</span>
                                        <span class="post-nav-item">Prev posts</span>
                                    </span>
                                </a>
                            </div>
                        
                        
                            <div class="next-post">
                                <a class="next" rel="next" href="/2024/11/04/course-CS267-3-Matrix-Multiplication-and-the-Roofline-Model/" title="Matrix Multiplication and  the Roofline Model">
                                    <span class="title flex-center">
                                        <span class="post-nav-title-item text-ellipsis">Matrix Multiplication and  the Roofline Model</span>
                                        <span class="post-nav-item">Next posts</span>
                                    </span>
                                    <span class="right arrow-icon flex-center">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </a>
                            </div>
                        
                    </div>
                

                
                    






                
            </div>
        </div>

        
            <div class="pc-post-toc right-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#shared-memory"><span class="nav-text">Shared Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parallel-programming-with-threads"><span class="nav-text">Parallel Programming with
Threads</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#recall-data-race-example"><span class="nav-text">Recall Data Race Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#a-programmers-view-of-openmp"><span class="nav-text">A Programmer's View of OpenMP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shared-memory-hardware-and-memory-consistency"><span class="nav-text">Shared Memory
Hardware and Memory Consistency</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-coherence-problem"><span class="nav-text">Cache Coherence Problem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parallel-pi-program"><span class="nav-text">Parallel PI Program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#why-such-poor-scaling-false-sharing"><span class="nav-text">Why such poor scaling?
False sharing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronization"><span class="nav-text">Synchronization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loop-worksharing-constructs-the-schedule-clause"><span class="nav-text">Loop
worksharing constructs: The schedule clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#static-vs-dynamic-example"><span class="nav-text">Static vs dynamic example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reduction"><span class="nav-text">Reduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#the-nowait-clause"><span class="nav-text">The nowait clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-environment-default-storage-attributes"><span class="nav-text">Data environment:
Default storage attributes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-sharing-changing-storage-attributes"><span class="nav-text">Data sharing: Changing
storage attributes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#private-clause"><span class="nav-text">Private clause</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#first-private-clause"><span class="nav-text">First private clause</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-sharing-default-clause"><span class="nav-text">Data sharing: Default clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-are-tasks"><span class="nav-text">What are tasks?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#single-worksharing-construct"><span class="nav-text">Single worksharing Construct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whenwhere-are-tasks-complete"><span class="nav-text">When/where are tasks
complete?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fibonacci-numbers"><span class="nav-text">Fibonacci numbers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronization-atomic"><span class="nav-text">Synchronization: atomic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flush-operation"><span class="nav-text">Flush operation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#take-away"><span class="nav-text">Take Away</span></a></li></ol>
    </div>
</div>

            </div>
        
    </div>
</div>


                
            </div>
        </div>

        <div class="page-main-content-bottom border-box">
            
<footer class="footer border-box">
    <div class="copyright-info info-item">
        ©&nbsp;<span>2020</span>&nbsp;-&nbsp;2024
        
            &nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;&nbsp;<a href="/">amor mío de mi vida</a>
        
    </div>

    <div class="theme-info info-item">
        Powered by&nbsp;<a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;&amp;&nbsp;Theme&nbsp;<a class="keep-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep</a>
    </div>

    

    
        <div class="count-info info-item">
            

            
                <span class="count-item border-box uv">
                    <span class="item-type border-box">Unique Visitor</span>
                    <span class="item-value border-box uv" id="busuanzi_value_site_uv"></span>
                </span>
            

            
                <span class="count-item border-box pv">
                    <span class="item-type border-box">Page View</span>
                    <span class="item-value border-box pv" id="busuanzi_value_site_pv"></span>
                </span>
            
        </div>
    

    
</footer>

        </div>
    </div>

    <!-- post tools -->
    
        <div class="post-tools right-toc">
            <div class="post-tools-container border-box">
    <ul class="post-tools-list border-box">
        <!-- PC encrypt again -->
        

        <!-- PC TOC show toggle -->
        
            <li class="tools-item flex-center toggle-show-toc">
                <i class="fas fa-list"></i>
            </li>
        

        <!-- PC go comment -->
        

        <!-- PC full screen -->
        <li class="tools-item flex-center full-screen">
            <i class="fa-solid fa-expand"></i>
        </li>
    </ul>
</div>

        </div>
    

    <!-- side tools -->
    <div class="side-tools">
        <div class="side-tools-container border-box ">
    <ul class="side-tools-list side-tools-show-handle border-box">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <!-- toggle mode -->
        
            <li class="tools-item tool-toggle-theme-mode flex-center">
                <i class="fas fa-moon"></i>
            </li>
        

        <!-- rss -->
        

        <!-- to bottom -->
        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list border-box">
        
            <li class="tools-item toggle-show-toc-tablet flex-center">
                <i class="fas fa-list"></i>
            </li>
        

        

        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>

        <li class="tools-item tool-scroll-to-top flex-center show-arrow">
            <i class="arrow fas fa-arrow-up"></i>
            <span class="percent"></span>
        </li>
    </ul>
</div>

    </div>

    <!-- image mask -->
    <div class="zoom-in-image-mask">
    <img class="zoom-in-image">
</div>


    <!-- local search -->
    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off" autocorrect="off" autocapitalize="off" placeholder="Search..." spellcheck="false" type="search" class="search-input">
            </div>
            <span class="close-popup-btn">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

    <!-- tablet toc -->
    
        <div class="tablet-post-toc-mask">
            <div class="tablet-post-toc">
                <div class="post-toc-wrap border-box">
    <div class="post-toc border-box">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#shared-memory"><span class="nav-text">Shared Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#parallel-programming-with-threads"><span class="nav-text">Parallel Programming with
Threads</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#recall-data-race-example"><span class="nav-text">Recall Data Race Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#a-programmers-view-of-openmp"><span class="nav-text">A Programmer's View of OpenMP</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#shared-memory-hardware-and-memory-consistency"><span class="nav-text">Shared Memory
Hardware and Memory Consistency</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cache-coherence-problem"><span class="nav-text">Cache Coherence Problem</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#parallel-pi-program"><span class="nav-text">Parallel PI Program</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#why-such-poor-scaling-false-sharing"><span class="nav-text">Why such poor scaling?
False sharing</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronization"><span class="nav-text">Synchronization</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#loop-worksharing-constructs-the-schedule-clause"><span class="nav-text">Loop
worksharing constructs: The schedule clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#static-vs-dynamic-example"><span class="nav-text">Static vs dynamic example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reduction"><span class="nav-text">Reduction</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#the-nowait-clause"><span class="nav-text">The nowait clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-environment-default-storage-attributes"><span class="nav-text">Data environment:
Default storage attributes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-sharing-changing-storage-attributes"><span class="nav-text">Data sharing: Changing
storage attributes</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#private-clause"><span class="nav-text">Private clause</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#first-private-clause"><span class="nav-text">First private clause</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-sharing-default-clause"><span class="nav-text">Data sharing: Default clause</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-are-tasks"><span class="nav-text">What are tasks?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#single-worksharing-construct"><span class="nav-text">Single worksharing Construct</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#whenwhere-are-tasks-complete"><span class="nav-text">When/where are tasks
complete?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#fibonacci-numbers"><span class="nav-text">Fibonacci numbers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronization-atomic"><span class="nav-text">Synchronization: atomic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#flush-operation"><span class="nav-text">Flush operation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#take-away"><span class="nav-text">Take Away</span></a></li></ol>
    </div>
</div>

            </div>
        </div>
    
</main>





<!-- common js -->

<script src="/js/utils.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/toggle-theme.js"></script>

<script src="/js/code-block.js"></script>

<script src="/js/main.js"></script>

<script src="/js/libs/anime.min.js"></script>


<!-- local search -->

    
<script src="/js/local-search.js"></script>



<!-- lazyload -->

    
<script src="/js/lazyload.js"></script>



<div class="pjax">
    <!-- home page -->
    

    <!-- post page -->
    
        <!-- post-helper -->
        
<script src="/js/post/post-helper.js"></script>


        <!-- toc -->
        
            
<script src="/js/post/toc.js"></script>

        

        <!-- copyright-info -->
        
            
<script src="/js/post/copyright-info.js"></script>

        

        <!-- share -->
        
            
<script src="/js/post/share.js"></script>

        
    

    <!-- categories page -->
    

    <!-- links page -->
    

    <!-- photos page -->
    

    <!-- tools page -->
    
</div>

<!-- mermaid -->

    
<script src="//cdn.jsdelivr.net/npm/mermaid@10.5.0/dist/mermaid.min.js"></script>

    <script data-pjax="">
      if (window.mermaid) {
        mermaid.init()
      }
    </script>






<!-- pjax -->

    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart()
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd()
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'))
            KEEP.initExecute()
        });
    });
</script>






<script type="text/javascript" charset="utf-8" src="/js/lazyload-plugin/lazyload.intersectionObserver.min.js"></script></body></html>